# Markdown River 项目记忆

## 项目核心

### 问题定义

这是一个解决 **AI 聊天应用中 Markdown 流式渲染闪烁问题** 的前端库项目。

**根本问题**：

- 后端以字符流方式返回 Markdown 文本
- 传统框架（如 react-markdown）逐字符渲染时，格式符号会先显示为普通字符，识别后突然转换为格式，造成视觉闪烁
- 简单的缓存策略会导致输出卡顿，影响用户体验

### 解决思路

通过实现智能的增量解析器和平滑的渲染调度，在保持流畅输出的同时避免格式符号的闪烁。

## 技术决策

### 架构设计

采用模块化架构，各模块职责明确：

- **核心渲染器**：协调各模块，管理渲染流程
- **增量解析**：智能识别潜在格式标记，避免错误渲染
- **渲染调度**：保证稳定的输出速率，避免卡顿
- **事件系统**：解耦各模块，便于扩展

### 关键特性

1. **前瞻解析**：预测可能的格式标记，减少渲染修正
2. **平滑输出**：即使处理复杂格式也保持稳定速率
3. **样式映射**：支持自定义标签到 CSS 类的映射

## 实现要点

### 核心挑战

- **状态管理**：需要维护跨多次输入的解析状态
- **性能平衡**：在准确性和响应速度间找到平衡
- **回溯处理**：最小化对已渲染内容的修改

### 技术栈

- TypeScript：类型安全，便于维护
- Vitest：适合流式场景的测试
- 原生 DOM API：避免框架依赖，提高性能

## 使用场景

### 主要应用

- AI 对话界面的响应渲染
- 实时协作编辑器
- 流式内容展示

### 集成方式

```javascript
// 基础使用
const renderer = new StreamingMarkdownRenderer({
  styleMap: new Map([
    ['h1', 'text-4xl font-bold'],
    ['strong', 'font-semibold text-gray-900'],
  ]),
});

// 处理流式输入
renderer.write(chunk);
```

## 开发指南

### 命令速查

```bash
npm run dev        # 开发模式
npm run build      # 构建生产版本
npm run test       # 运行测试
npm run lint       # 代码检查
npm run typecheck  # 类型检查
```

### 注意事项

1. 测试重点关注流式输入的边界情况
2. 性能监控确保大量输入时的响应速度
3. 保持 API 简洁，降低使用门槛

## 项目状态

- 已完成需求文档编写
- 定义了核心功能和技术方案
- 明确了样式自定义需求

<!-- 最后回顾: 2025-01-09 -->
<!-- 核心需求和技术方向已明确 -->
