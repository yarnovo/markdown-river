# Markdown River 项目记忆

## 项目概述

Markdown River 是一个专注于流式 Markdown 渲染的库，提供智能的增量解析和渲染能力。

## 重要实现细节

### React 集成示例

- 位置：`examples/react-vite/`
- 实现了智能的 HTML 流式渲染功能
- 特别注意：需要处理 HTML 标签的完整性，避免渲染不完整的标签

### 流式 HTML 安全渲染架构（重要更新）

实现了三列布局的流式渲染系统：

1. **原始流式 HTML**（左侧 25%）：逐字符增长的原始内容，可能包含不完整标签
2. **安全 HTML**（中间 25%）：通过 `convertToSafeHtml` 过滤掉末尾不完整标签
3. **渲染效果**（右侧 50%）：直接渲染安全 HTML，无需额外分词处理

数据流简化为：

```
streamHtml → convertToSafeHtml → safeHtml → displayHtml
```

### 安全转换函数实现

`convertToSafeHtml` 函数的关键逻辑：

- 从末尾向前查找最后一个 `<` 符号
- 检查是否在代码块中（通过统计 `<code>` 和 `</code>` 标签数量）
- 如果 `<` 后面没有对应的 `>`，截断到 `<` 之前
- 代码块中的 `<` 作为普通字符处理，不截断

### UI/UX 设计偏好

- **布局**：三列布局（25% + 25% + 50%），全屏显示
- **样式**：简洁卡片式设计，避免聊天对话框样式
- **交互**：动态按钮文字（开始演示/重新开始）
- **信息展示**：每列顶部显示字符数统计
- **视觉区分**：黄色背景（原始）、绿色背景（安全）、白色背景（渲染）
- **空间优化**：无滚动条限制，内容自适应高度

### 测试数据扩展

- 使用 `test-suite/index.js` 中的丰富 Markdown 示例
- 需要覆盖各种 HTML 元素：标题、列表、代码块、表格、引用等
- 使用可靠的 CDN 服务（如 picsum.photos、placeholder.com）

## 开发注意事项

### 代码质量检查

- 运行 `npm run check` 进行完整检查（lint + typecheck + test）
- research 目录下的实验性代码可能有 lint 错误，但不影响主项目

### React 示例开发

- 使用 Vite 作为开发服务器
- 默认端口 3006，如被占用会自动切换
- 支持 `dangerouslySetInnerHTML` 进行 HTML 渲染

## 技术决策

### 流式渲染方案

选择逐字符输出而非块输出的原因：

- 更真实地模拟 AI 输出效果
- 用户体验更流畅
- 但需要智能分词确保 HTML 结构完整性

### 性能优化

- 使用 `setInterval` 而非递归 `setTimeout`
- 通过 `useRef` 存储状态避免闭包问题
- 清理定时器防止内存泄漏

### 调试功能

- 大跳跃检测：当一次输出超过100个字符时记录日志
- 实时显示当前字符位置和内容
- HTML 源码实时预览

<!-- 最后更新时间: 2025-01-11T16:25:00+08:00 -->
