# Markdown River 项目记忆

## 项目概述

Markdown River 是一个专注于流式 Markdown 渲染的库，提供智能的增量解析和渲染能力。

## 重要实现细节

### React 集成示例

- 位置：`examples/react-vite/`
- 实现了智能的 HTML 流式渲染功能
- 特别注意：需要处理 HTML 标签的完整性，避免渲染不完整的标签

### 流式 HTML 安全渲染架构（重要更新）

实现了三列布局的流式渲染系统：

1. **原始流式 HTML**（左侧 25%）：逐字符增长的原始内容，可能包含不完整标签
2. **安全 HTML**（中间 25%）：通过 `convertToSafeHtml` 过滤掉末尾不完整标签
3. **渲染效果**（右侧 50%）：直接渲染安全 HTML，无需额外分词处理

数据流简化为：

```
streamHtml → convertToSafeHtml → safeHtml → displayHtml
```

### 核心架构：事件驱动 API

MarkdownRiver 使用事件驱动架构，适合 AI 流式聊天场景：

**API 设计**：

- `onHtmlUpdate(listener)` - 注册 HTML 更新监听器
- `offHtmlUpdate(listener)` - 移除监听器
- `write(chunk)` - 写入 HTML 片段，触发监听器
- `reset()` - 重置状态，触发监听器
- **移除了 `end()` 方法** - AI 聊天场景不需要显式结束

**优化特性**：

- 只在安全 HTML 实际发生变化时才触发事件
- 支持多个监听器同时注册
- 自动异常处理，避免单个监听器错误影响其他监听器

### 安全转换函数实现

`convertToSafeHtml` 函数的智能标签识别逻辑：

**核心策略**：遇到末尾的 `<` 或 `</` 时，默认推测为不完整标签并过滤，除非明确判断不可能是标签

**例外情况（保留为普通字符）**：

- `a < 5` - < 后跟数字或空格，识别为比较运算符
- `price < !` - < 后跟标点符号，识别为普通字符

**默认策略（过滤等待完整标签）**：

- `<` - 单独的 < 符号
- `</` - 单独的 </ 符号
- `<div` - < 后跟字母，推测为开始标签
- `</div` - </ 后跟字母，推测为结束标签

**特殊处理**：

- 代码块检测：统计 `<code>` 和 `</code>` 标签数量判断是否在代码块中
- 代码块中的 `<` 作为普通字符处理，不过滤

### UI/UX 设计偏好

- **布局**：三列布局（25% + 25% + 50%），全屏显示
- **样式**：简洁卡片式设计，避免聊天对话框样式
- **交互**：动态按钮文字（开始演示/重新开始）
- **信息展示**：每列顶部显示字符数统计
- **视觉区分**：黄色背景（原始）、绿色背景（安全）、白色背景（渲染）
- **空间优化**：无滚动条限制，内容自适应高度

### 测试体系

**E2E 测试框架**：

- 位置：`tests/e2e/io-runner.test.ts`
- 使用 JSON 驱动的测试数据，每个测试用例包含：
  - `chunks[]` - 输入的 HTML 片段序列
  - `expectedOutputs[]` - 期望的事件触发序列
- 自动测试所有 `tests/e2e/io/*.json` 文件

**核心测试用例**：

- `html-basic.json` - 基本 HTML 标签流式输入
- `html-incomplete.json` - 不完整标签过滤
- `html-code-block.json` - 代码块中的 < 符号保留
- `html-comparison-operators.json` - 比较运算符识别
- `html-attributes.json` - 跨多次写入的属性处理
- `html-mixed-scenarios.json` - 标签和比较符混合场景

**测试设计原则**：

- 验证事件驱动 API 只在安全 HTML 变化时触发
- 覆盖各种边界情况和异常场景
- 确保比较运算符 vs HTML 标签的正确识别

## 开发注意事项

### 代码质量检查

- 运行 `npm run check` 进行完整检查（lint + typecheck + test）
- research 目录下的实验性代码可能有 lint 错误，但不影响主项目

### React 示例开发

- 使用 Vite 作为开发服务器
- 默认端口 3006，如被占用会自动切换
- 支持 `dangerouslySetInnerHTML` 进行 HTML 渲染

## 技术决策

### 架构演进：从 Markdown AST 到 HTML 流式安全

**背景**：原本基于 Markdown AST 解析，但发现 HTML 流式处理更适合 AI 聊天场景

**关键转变**：

- 删除了 `MarkdownTransformer` 复杂的 AST 处理逻辑
- 重构为专注 HTML 流式安全的 `MarkdownRiver` 类
- 从返回值模式改为事件驱动架构

**选择 HTML 而非 Markdown 的原因**：

- HTML 标签有明确边界（`<` 和 `>`），便于识别完整性
- 本地上下文就足够判断标签状态，无需全局解析
- 更适合逐字符流式输入的实时处理

### API 设计原则

**事件驱动架构选择**：

- AI 聊天场景不需要显式的 `end()` 调用
- 异常中断时不希望显示不完整的内容
- 支持多个组件同时监听同一个流

**性能优化策略**：

- 只在安全 HTML 实际变化时才通知监听器
- 避免无意义的重复渲染
- 从末尾开始的局部分析，避免全文扫描

### 调试和测试策略

- JSON 驱动的测试数据，便于添加边界用例
- 三列布局实时展示转换过程，便于调试
- 完整覆盖比较运算符 vs HTML 标签的识别场景

<!-- 最后更新时间: 2025-01-11T17:58:00+08:00 -->
