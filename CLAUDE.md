# Markdown River 项目记忆

## 项目核心

### 问题定义

这是一个解决 **AI 聊天应用中 Markdown 流式渲染闪烁问题** 的前端库项目。

**一句话概括**：开发流式 Markdown 渲染器，解决 AI 聊天中因逐字符渲染导致的格式符号闪烁问题。

**根本问题**：

- 后端以字符流方式返回 Markdown 文本
- 传统框架（如 react-markdown）逐字符渲染时，格式符号会先显示为普通字符，识别后突然转换为格式，造成视觉闪烁
- 简单的缓存策略会导致输出卡顿，影响用户体验

**具体表现**：当 AI 返回 `**加粗文本**` 时，用户会先看到星号，然后突然变成加粗格式，体验很差。

### 解决思路

通过实现智能的增量解析器和平滑的渲染调度，在保持流畅输出的同时避免格式符号的闪烁。

**核心方案**：智能缓冲延迟 + 预判解析 + 平滑输出

## 技术决策

### 架构设计

采用模块化架构，包含核心组件和支撑模块：

**核心组件**：

1. **缓冲管理器（智能仓库）**：环形缓冲区，支持回溯
2. **增量解析器（聪明大脑）**：智能预判，生成可能性令牌
3. **渲染调度器（节奏控制）**：控制输出速率，保持平滑

**支撑模块**：

- **DOM 管理器**：增量更新，批量操作
- **事件总线**：模块间通信，解耦架构
- **样式处理器**：自定义样式映射

### 关键特性

1. **智能预判**：不是确定性令牌，而是可能性令牌
2. **平滑输出**：单一目标，不让用户选择策略
3. **优雅回溯**：超时机制 + 自适应阈值
4. **样式映射**：支持自定义标签到 CSS 类的映射

## 实现要点

### 核心挑战

- **不确定性处理**：处理流式输入的格式预判
- **速率控制**：在缓冲延迟和实时性间平衡
- **回溯机制**：最小化对用户体验的影响

### 技术栈选择理由

- **TypeScript**：类型安全，减少运行时错误
- **Vitest**：适合流式场景的测试，支持模拟异步流
- **原生 DOM API**：避免框架依赖，更直接的性能控制
- **事件驱动架构**：模块解耦，易于扩展

### 数据流设计

```
输入流 → 缓冲管理器 → 增量解析器 → 令牌流 → 渲染调度器 → DOM更新 → 输出
```

关键机制：

1. **智能缓冲**：基于上下文决定是否缓冲
2. **可能性令牌**：`POTENTIAL_BOLD` 而不是 `BOLD_START`
3. **自适应超时**：根据输入速率动态调整
4. **平滑调度**：保持稳定的输出节奏

## 开发经验

### 代码规范

1. **ESLint + Prettier**：严格的代码格式检查
2. **TypeScript 严格模式**：避免 `any` 类型，使用 `unknown`
3. **中文注释**：代码注释和文档使用中文
4. **测试先行**：每个模块都有完整的单元测试

### 项目结构

```
src/
├── core/                # 核心组件
├── infrastructure/      # 基础设施（事件总线等）
├── types/              # 类型定义
└── utils/              # 工具函数

tests/
└── infrastructure/     # 对应的测试文件
```

### 开发流程

1. 先定义 TypeScript 接口
2. 实现核心功能
3. 编写全面的单元测试
4. 运行完整的检查流程（lint + typecheck + test）

## 使用场景

### 主要应用

- AI 对话界面的响应渲染
- 实时协作编辑器
- 流式内容展示

### 集成方式

```javascript
// 基础使用
const renderer = new StreamingMarkdownRenderer({
  styleMap: new Map([
    ['h1', 'text-4xl font-bold'],
    ['strong', 'font-semibold text-gray-900'],
  ]),
});

// 处理流式输入
renderer.write(chunk);
renderer.end();
```

## 开发指南

### 命令速查

```bash
npm run dev        # 开发模式
npm run build      # 构建生产版本
npm run test       # 运行测试
npm run lint       # 代码检查
npm run typecheck  # 类型检查
npm run check      # 完整检查（lint + typecheck + test）
```

### 注意事项

1. 所有代码必须通过 `npm run check`
2. 使用 `unknown` 而不是 `any` 类型
3. 事件系统支持优先级、过滤、异步处理
4. 测试要覆盖边界情况和错误处理

## 项目状态

### 已完成

- ✅ 需求文档编写（REQUIREMENTS.md）
- ✅ 架构设计文档（ARCHITECTURE.md）
- ✅ 博客文章编写（两篇技术博客）
- ✅ 项目基础结构搭建
- ✅ 事件总线模块（完整实现 + 测试）

### 核心洞察

1. **延迟是特性，不是缺点**：通过智能缓冲延迟获得预判时间
2. **单一目标原则**：只追求平滑，不给用户选择的困扰
3. **令牌系统精髓**：可能性令牌 + 确认机制 + 撤销机制

## 架构要点速查

### 事件总线设计

- **优先级排序**：高优先级监听器先执行
- **条件过滤**：支持过滤条件决定是否执行
- **错误隔离**：单个监听器出错不影响其他监听器
- **异步支持**：完整的 Promise 支持
- **内存管理**：自动清理一次性监听器

### 关键设计模式

- **事件驱动**：模块间通过事件总线通信
- **策略模式**：令牌处理的不同策略
- **状态机模式**：解析器的状态管理（待实现）
- **观察者模式**：事件监听机制

### 开发规约

- **类型安全**：严格的 TypeScript 类型检查
- **测试覆盖**：每个模块都要有完整测试
- **文档同步**：代码更新同步更新文档
- **中文优先**：注释和文档优先使用中文

<!-- 最后回顾: 2025-07-09 -->
<!-- 事件总线模块已完成，包含完整的测试和类型定义 -->
<!-- 博客文章已完成，详细解释了架构设计和流式处理机制 -->
