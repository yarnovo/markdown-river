# Markdown River 项目记忆

## 项目核心

### 问题定义

这是一个解决 **AI 聊天应用中 Markdown 流式渲染闪烁问题** 的前端库项目。

**根本问题**：

- 后端以字符流方式返回 Markdown 文本
- 传统框架（如 react-markdown）逐字符渲染时，格式符号会先显示为普通字符，识别后突然转换为格式，造成视觉闪烁
- 简单的缓存策略会导致输出卡顿，影响用户体验

### 解决思路

通过实现智能的增量解析器和平滑的渲染调度，在保持流畅输出的同时避免格式符号的闪烁。

## 技术决策

### 架构设计

采用分层模块化架构，包含 8 个核心模块：

1. **StreamingMarkdownRenderer**（核心渲染器）：协调各模块，提供统一 API
2. **IncrementalParser**（增量解析器）：维护解析状态机，生成令牌流
3. **RenderScheduler**（渲染调度器）：控制渲染速率，支持多种策略
4. **DOMManager**（DOM 管理器）：管理 DOM 操作，实现增量更新
5. **StyleProcessor**（样式处理器）：处理样式映射和应用
6. **BufferManager**（缓冲管理器）：优化内存使用，支持回溯
7. **EventBus**（事件总线）：模块间通信，解耦架构
8. **PerformanceMonitor**（性能监控器）：收集性能指标，提供优化建议

### 关键特性

1. **前瞻解析**：预测可能的格式标记，减少渲染修正
2. **平滑输出**：即使处理复杂格式也保持稳定速率
3. **样式映射**：支持自定义标签到 CSS 类的映射
4. **插件系统**：支持功能扩展和自定义规则

## 实现要点

### 核心挑战

- **状态管理**：需要维护跨多次输入的解析状态
- **性能平衡**：在准确性和响应速度间找到平衡
- **回溯处理**：最小化对已渲染内容的修改

### 技术栈选择理由

- **TypeScript**：类型安全，减少运行时错误，便于大型项目维护
- **Vitest**：适合流式场景的测试，支持模拟异步流
- **原生 DOM API**：避免框架依赖，更直接的性能控制，减小打包体积
- **事件驱动架构**：模块解耦，易于扩展，便于调试监控

### 数据流设计

```
输入流 → 缓冲管理器 → 增量解析器 → 令牌流 → 渲染调度器 → DOM更新 → 输出
```

关键环节：

1. **缓冲策略**：环形缓冲区，固定内存占用
2. **令牌生成**：包含类型、内容、位置信息
3. **调度策略**：smooth（平滑）、responsive（响应）、balanced（平衡）
4. **DOM 优化**：批量更新，最小化重排重绘

## 使用场景

### 主要应用

- AI 对话界面的响应渲染
- 实时协作编辑器
- 流式内容展示

### 集成方式

```javascript
// 基础使用
const renderer = new StreamingMarkdownRenderer({
  styleMap: new Map([
    ['h1', 'text-4xl font-bold'],
    ['strong', 'font-semibold text-gray-900'],
  ]),
});

// 处理流式输入
renderer.write(chunk);
```

## 开发指南

### 命令速查

```bash
npm run dev        # 开发模式
npm run build      # 构建生产版本
npm run test       # 运行测试
npm run lint       # 代码检查
npm run typecheck  # 类型检查
```

### 注意事项

1. 测试重点关注流式输入的边界情况
2. 性能监控确保大量输入时的响应速度
3. 保持 API 简洁，降低使用门槛

## 项目状态

- 已完成需求文档编写（REQUIREMENTS.md）
- 已完成架构设计文档（ARCHITECTURE.md）
- 定义了核心功能和技术方案
- 明确了样式自定义需求
- 确定了模块化分层架构

## 架构要点速查

### 模块职责划分

- **解析层**：处理 Markdown 语法识别和令牌生成
- **调度层**：控制渲染节奏，平衡性能和体验
- **渲染层**：管理 DOM 操作和样式应用
- **基础层**：提供事件、缓冲、监控等支持

### 关键设计模式

- **状态机模式**：解析器维护复杂的解析状态
- **观察者模式**：事件总线实现模块解耦
- **策略模式**：支持多种渲染调度策略
- **对象池模式**：复用频繁创建的对象

<!-- 最后回顾: 2025-01-09 -->
<!-- 架构设计已完成，明确了8个核心模块和数据流 -->
