# Markdown River 项目记忆

## 项目概述

Markdown River 是一个专注于流式 Markdown 渲染的库，提供智能的增量解析和渲染能力。

## 重要实现细节

### React 集成示例

- 位置：`examples/react-vite/`
- 实现了智能的 HTML 流式渲染功能
- 特别注意：需要处理 HTML 标签的完整性，避免渲染不完整的标签

### 流式 HTML 安全渲染架构（重要更新）

实现了三列布局的流式渲染系统：

1. **原始流式 HTML**（左侧 25%）：逐字符增长的原始内容，可能包含不完整标签
2. **安全 HTML**（中间 25%）：通过 `convertToSafeHtml` 过滤掉末尾不完整标签
3. **渲染效果**（右侧 50%）：直接渲染安全 HTML，无需额外分词处理

数据流简化为：

```
streamHtml → convertToSafeHtml → safeHtml → displayHtml
```

### 核心架构：事件驱动 API

MarkdownRiver 使用事件驱动架构，适合 AI 流式聊天场景：

**API 设计**：

- `onHtmlUpdate(listener)` - 注册 HTML 更新监听器
- `offHtmlUpdate(listener)` - 移除监听器
- `write(chunk)` - 写入 HTML 片段，触发监听器
- `reset()` - 重置状态，触发监听器
- **移除了 `end()` 方法** - AI 聊天场景不需要显式结束

**优化特性**：

- 只在安全 HTML 实际发生变化时才触发事件
- 支持多个监听器同时注册
- 自动异常处理，避免单个监听器错误影响其他监听器

### 安全转换函数实现（最终简化版）

`convertToSafeHtml` 函数的智能标签识别逻辑：

**核心策略**：遇到末尾的 `<` 或 `</` 时，默认推测为不完整标签并过滤，除非明确判断不可能是标签

**唯一例外情况**：

- 如果 `<` 后面不是字母或斜杠，说明不可能是 HTML 标签，保留为普通字符
- 正则表达式：`/^[^a-zA-Z/]/`

**保留场景示例**：

- `a < 5` - 比较运算符
- `price < $50` - 特殊字符
- `x < !` - 标点符号

**过滤场景示例**：

- `<` - 单独的 < 符号
- `</` - 单独的 </ 符号
- `<div` - 不完整的开始标签
- `< div>` - 空格后跟标签名

**特殊处理**：

- 代码块检测：统计 `<code>` 和 `</code>` 标签数量判断是否在代码块中
- 代码块中的 `<` 作为普通字符处理，不过滤

### UI/UX 设计偏好

- **布局**：三列布局（25% + 25% + 50%），全屏显示
- **样式**：简洁卡片式设计，避免聊天对话框样式
- **交互**：动态按钮文字（开始演示/重新开始）
- **信息展示**：每列顶部显示字符数统计
- **视觉区分**：黄色背景（原始）、绿色背景（安全）、白色背景（渲染）
- **空间优化**：无滚动条限制，内容自适应高度

### 测试体系

**E2E 测试框架**：

- 位置：`tests/e2e/runner.test.ts`（重命名后）
- 使用 JSON 驱动的测试数据，每个测试用例包含：
  - `chunks[]` - 输入的 HTML 片段序列
  - `expectedOutputs[]` - 期望的事件触发序列
- 自动测试所有 `tests/e2e/io/*.json` 文件

**核心测试用例**（14个）：

- `html-basic.json` - 基本 HTML 标签流式输入
- `html-incomplete.json` - 不完整标签过滤
- `html-code-block.json` - 代码块中的 < 符号保留
- `html-comparison-operators.json` - 比较运算符识别
- `html-attributes.json` - 跨多次写入的属性处理
- `html-mixed-scenarios.json` - 标签和比较符混合场景
- `html-space-after-bracket.json` - < 后跟空格的处理
- `html-incomplete-wait.json` - 不完整标签等待机制
- `html-special-cases.json` - 特殊情况处理

**测试设计原则**：

- 验证事件驱动 API 只在安全 HTML 变化时触发（重要）
- 覆盖各种边界情况和异常场景
- 确保比较运算符 vs HTML 标签的正确识别
- 测试预期必须符合"只在变化时触发"的原则

## 项目清理记录

**删除的目录**：

- `src/events` - 事件系统相关代码
- `src/types` - 类型定义
- `test-suite` - 旧的测试套件

**保留的核心结构**：

- `src/core/MarkdownRiver.ts` - 核心实现
- `tests/e2e/` - E2E 测试
- `examples/react-vite/` - React 示例
- `demo/` - 演示页面

## Demo 开发注意事项

### Demo 架构

- **文件加载路径**：demo 从 `demo/static/` 加载编译后的文件
- **构建流程**：`npm run build && cp -r dist/* demo/static/`
- **自动启动**：页面加载时自动开始流式演示，切换示例也立即开始

### Demo 功能特性

- **速度控制**：支持实时调整速度（5ms-300ms），拖动滑块时立即生效
- **无光标设计**：移除了打字光标，避免表格等复杂内容渲染时的问题
- **示例内容**：提供5个预设示例（欢迎、完整功能、代码、比较运算符、表格）

### UI 框架选择

- **使用 Tailwind CSS CDN**：通过 `<script src="https://cdn.tailwindcss.com"></script>` 引入
- **样式处理**：使用 `@apply` 指令为 Markdown 元素应用样式
- **注意事项**：Tailwind 4.0 可能需要额外配置才能正确渲染 Markdown 样式

## 开发注意事项

### 代码质量检查

- 运行 `npm run check` 进行完整检查（lint + typecheck + test）
- 使用 `npm run lint -- --fix` 自动修复格式问题
- research 目录下的实验性代码可能有 lint 错误，但不影响主项目

### React 示例开发

- 使用 Vite 作为开发服务器
- 默认端口 3006，如被占用会自动切换
- 支持 `dangerouslySetInnerHTML` 进行 HTML 渲染
- 导入路径修改：从 TypeScript 源文件导入（.ts 扩展名）

## 技术决策

### 架构演进：从 Markdown AST 到 HTML 流式安全

**背景**：原本基于 Markdown AST 解析，但发现 HTML 流式处理更适合 AI 聊天场景

**关键转变**：

- 删除了 `MarkdownTransformer` 复杂的 AST 处理逻辑
- 重构为专注 HTML 流式安全的 `MarkdownRiver` 类
- 从返回值模式改为事件驱动架构

**选择 HTML 而非 Markdown 的原因**：

- HTML 标签有明确边界（`<` 和 `>`），便于识别完整性
- 本地上下文就足够判断标签状态，无需全局解析
- 更适合逐字符流式输入的实时处理

### API 设计原则

**事件驱动架构选择**：

- AI 聊天场景不需要显式的 `end()` 调用
- 异常中断时不希望显示不完整的内容
- 支持多个组件同时监听同一个流

**性能优化策略**：

- 只在安全 HTML 实际变化时才通知监听器
- 避免无意义的重复渲染
- 从末尾开始的局部分析，避免全文扫描

### 调试和测试策略

- JSON 驱动的测试数据，便于添加边界用例
- 三列布局实时展示转换过程，便于调试
- 完整覆盖比较运算符 vs HTML 标签的识别场景

## 用户偏好模式

### 界面交互偏好

- **自动演示**：进入页面即开始演示，无需手动触发
- **即时反馈**：切换示例立即开始新演示，速度调整实时生效
- **简洁设计**：不需要复杂的控制面板，只显示核心功能

### 技术偏好

- **CSS 框架**：偏好使用 Tailwind CSS CDN 而非手写 CSS
- **代码简洁性**：偏好简化的逻辑实现（如安全转换函数的最终版本）
- **测试覆盖**：注重边界情况的测试覆盖

<!-- 最后更新时间: 2025-01-11T18:42:00+08:00 -->
